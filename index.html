<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mug Mapper – Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="styles.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    body { background:#111827; color:white; }
    #map { height: 55vh; }
    @media (min-width: 900px) { #map { height: 100vh; } }

    .gallery-container { padding:16px; }
    .like-button {
      cursor: pointer;
      font-size: 1.2rem;
      user-select: none;
    }
  </style>
</head>

<body>

<!-- Header include -->
<div id="mm-header"></div>

<div id="map"></div>

<div class="gallery-container">
  <h3 id="galleryTitle">Select a mug icon</h3>
  <div id="galleryGrid" class="gallery-grid"></div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox">
  <div class="lightbox-inner">
    <div class="lightbox-img-wrapper">
      <img id="lightboxImg" src="">
    </div>
    <div class="lightbox-meta">
      <div class="lightbox-title" id="lightboxTitle"></div>
      <div class="lightbox-subtitle" id="lightboxSubtitle"></div>
      <div class="lightbox-chips">
        <div class="chip" id="lightboxYear"></div>
        <div class="chip" id="lightboxLocation"></div>
      </div>
      <div id="lightboxLikes" class="like-button"></div>
    </div>

    <div class="lightbox-controls">
      <button id="lightboxPrev" class="lightbox-btn lightbox-prev">&#10094;</button>
      <button id="lightboxNext" class="lightbox-btn lightbox-next">&#10095;</button>
      <button id="lightboxClose" class="lightbox-btn lightbox-close">&#10005;</button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  /* Load shared header */
  await fetch("header.html").then(r => r.text()).then(html => {
    document.getElementById("mm-header").innerHTML = html;
  });

  /* Supabase Setup */
  const supabase = createClient(
    "https://tosyomhrxttlejwlqvsf.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvc3lvbWhyeHR0bGVqd2xxdnNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTQzMDIsImV4cCI6MjA3OTA3MDMwMn0.YukJ7MFLra2aDgvNXRYFSTEsxdGFMWy0I-pOm9CtQ_8"
  );

  /* Authentication elements (after header loads) */
  const authUserLabel = document.getElementById("authUserLabel");
  const loginGoogleButton = document.getElementById("loginGoogleButton");
  const loginEmailButton = document.getElementById("loginEmailButton");
  const logoutButton = document.getElementById("logoutButton");

  let currentUser = null;

  async function initAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session?.user ?? null;
    syncAuthUI();

    supabase.auth.onAuthStateChange((_event, session) => {
      currentUser = session?.user ?? null;
      syncAuthUI();
    });
  }

  function syncAuthUI() {
    if (currentUser) {
      authUserLabel.textContent = currentUser.email;
      logoutButton.style.display = "block";
      loginGoogleButton.style.display = "none";
      loginEmailButton.style.display = "none";
    } else {
      authUserLabel.textContent = "Not signed in";
      logoutButton.style.display = "none";
      loginGoogleButton.style.display = "block";
      loginEmailButton.style.display = "block";
    }
  }

  /* Login */
  loginGoogleButton.onclick = async () => {
    await supabase.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo: window.location.href }
    });
  };

  loginEmailButton.onclick = async () => {
    const email = prompt("Email for sign-in link:");
    if (!email) return;
    await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
    alert("Magic link sent.");
  };

  logoutButton.onclick = async () => {
    await supabase.auth.signOut();
  };

  await initAuth();

  /* Map */
  const map = L.map("map").setView([51.1657, 10.4515], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const mugIcon = L.divIcon({
    className: "mug-icon",
    html: "☕",
    iconSize: [40, 40],
    iconAnchor: [20, 40]
  });

  async function loadMarkets() {
    const { data: photoRows } = await supabase
      .from("mug_photos")
      .select("market_id")
      .eq("status", "approved");

    const marketIds = [...new Set(photoRows.map(p => p.market_id))];

    const { data: markets } = await supabase
      .from("markets")
      .select("id, market_name, city, country, lat, lng")
      .in("id", marketIds)
      .eq("status", "approved");

    markets.forEach(m => {
      if (!m.lat || !m.lng) return;
      const marker = L.marker([m.lat, m.lng], { icon: mugIcon }).addTo(map);
      marker.on("click", () => loadPhotos(m));
    });
  }

  await loadMarkets();

  const galleryGrid = document.getElementById("galleryGrid");
  const galleryTitle = document.getElementById("galleryTitle");

  let currentPhotos = [];
  let currentIndex = 0;

  async function loadPhotos(market) {
    galleryTitle.textContent = `${market.market_name} – ${market.city}, ${market.country}`;

    const { data: photos } = await supabase
      .from("mug_photos")
      .select("*")
      .eq("market_id", market.id)
      .eq("status", "approved")
      .order("like_count", { ascending: false });

    currentPhotos = photos;
    galleryGrid.innerHTML = "";

    photos.forEach((p, i) => {
      const div = document.createElement("div");
      div.className = "gallery-item";
      div.innerHTML = `
        <img src="${p.public_url}">
        <div class="gallery-item-info">
          <span>${p.year}</span>
          <span class="like-button" data-id="${p.id}">❤️ ${p.like_count}</span>
        </div>
      `;
      div.onclick = () => openLightbox(i);
      galleryGrid.appendChild(div);
    });
  }

  /* Lightbox */
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightboxImg");
  const lightboxTitle = document.getElementById("lightboxTitle");
  const lightboxSubtitle = document.getElementById("lightboxSubtitle");
  const lightboxYear = document.getElementById("lightboxYear");
  const lightboxLocation = document.getElementById("lightboxLocation");
  const lightboxLikes = document.getElementById("lightboxLikes");

  document.getElementById("lightboxClose").onclick = () => lightbox.classList.remove("visible");

  function openLightbox(i) {
    currentIndex = i;
    const p = currentPhotos[i];

    lightboxImg.src = p.public_url;
    lightboxTitle.textContent = "Mug Photo";
    lightboxSubtitle.textContent = p.caption ?? "";
    lightboxYear.textContent = p.year;
    lightboxLocation.textContent = galleryTitle.textContent;
    lightboxLikes.textContent = `❤️ ${p.like_count}`;
    lightboxLikes.onclick = () => likePhoto(p.id, true);

    lightbox.classList.add("visible");
  }

  document.getElementById("lightboxPrev").onclick = () => {
    if (!currentPhotos.length) return;
    currentIndex = (currentIndex - 1 + currentPhotos.length) % currentPhotos.length;
    openLightbox(currentIndex);
  };

  document.getElementById("lightboxNext").onclick = () => {
    if (!currentPhotos.length) return;
    currentIndex = (currentIndex + 1) % currentPhotos.length;
    openLightbox(currentIndex);
  };

  /* Likes */
  async function likePhoto(photoId, fromLightbox = false) {
    if (!currentUser) {
      alert("Sign in to like photos.");
      return;
    }

    const { data, error } = await supabase.rpc("increment_like", { photo_id: photoId });

    if (error) {
      console.error(error);
      return;
    }

    await loadPhotos({ id: currentPhotos[currentIndex].market_id });

    if (fromLightbox) openLightbox(currentIndex);
  }
</script>

</body>
</html>
