<div class="mm-header-bar">
  <div class="mm-header-left">
    <span class="mm-emoji">üó∫Ô∏è</span>
    <span class="mm-title">Mug Mapper</span>
  </div>

  <div id="mmHamburger" class="mm-hamburger">
    &#9776;
  </div>
</div>

<!-- Fullscreen overlay menu -->
<div id="mmNavOverlay" class="mm-nav-overlay" aria-hidden="true">
  <div class="mm-nav-content">
    <button id="mmNavClose" class="mm-nav-close">&times;</button>

    <a href="index.html" class="mm-nav-link">Home</a>
    <a href="upload.html" class="mm-nav-link">Upload</a>
    <a href="popular.html" class="mm-nav-link">Popular</a>
    <a href="leaderboard.html" class="mm-nav-link">Leaderboard</a>
    <a href="contact.html" class="mm-nav-link">Contact</a>
    <a href="support.html" class="mm-nav-link">Support</a>

    <!-- Admin link gets injected here dynamically -->
    <div id="adminLinkContainer"></div>

    <div class="mm-auth-section">
      <div id="authUserLabel" class="mm-auth-label">Not signed in</div>
      <button id="loginGoogleButton" class="mm-auth-btn mm-google-btn">Sign in with Google</button>
      <button id="loginEmailButton" class="mm-auth-btn mm-email-btn">Sign in with Email</button>
      <button id="logoutButton" class="mm-auth-btn mm-logout-btn" style="display:none;">Sign Out</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://tosyomhrxttlejwlqvsf.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvc3lvbWhyeHR0bGVqd2xxdnNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTQzMDIsImV4cCI6MjA3OTA3MDMwMn0.YukJ7MFLra2aDgvNXRYFSTEsxdGFMWy0I-pOm9CtQ_8";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const mmHamburger  = document.getElementById("mmHamburger");
  const mmNavOverlay = document.getElementById("mmNavOverlay");
  const mmNavClose   = document.getElementById("mmNavClose");
  const navLinks     = mmNavOverlay.querySelectorAll(".mm-nav-link");
  const adminContainer = document.getElementById("adminLinkContainer");

  const authUserLabel     = document.getElementById("authUserLabel");
  const loginGoogleButton = document.getElementById("loginGoogleButton");
  const loginEmailButton  = document.getElementById("loginEmailButton");
  const logoutButton      = document.getElementById("logoutButton");

  let currentUser = null;
  let isAdmin = false;

  // --- Navigation overlay handlers ---
  function openNav() {
    mmNavOverlay.style.display = "block";
    mmNavOverlay.setAttribute("aria-hidden", "false");
  }
  function closeNav() {
    mmNavOverlay.style.display = "none";
    mmNavOverlay.setAttribute("aria-hidden", "true");
  }

  mmHamburger?.addEventListener("click", openNav);
  mmNavClose?.addEventListener("click", closeNav);
  navLinks.forEach((link) => link.addEventListener("click", closeNav));

  // --- Update UI for user ---
  function updateAuthUI() {
    if (!authUserLabel) return;

    if (currentUser) {
      authUserLabel.textContent = currentUser.email;
      loginGoogleButton.style.display = "none";
      loginEmailButton.style.display  = "none";
      logoutButton.style.display      = "block";
    } else {
      authUserLabel.textContent = "Not signed in";
      loginGoogleButton.style.display = "block";
      loginEmailButton.style.display  = "block";
      logoutButton.style.display      = "none";
    }
  }

  // --- Check if user is an admin ---
  async function checkAdmin() {
    if (!currentUser) {
      isAdmin = false;
      return;
    }

    const { data, error } = await supabase
      .from("admin_users")
      .select("user_id")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    isAdmin = !!data;
    renderAdminLink();
  }

  // --- Insert/Remove Admin Link ---
  function renderAdminLink() {
    if (isAdmin) {
      adminContainer.innerHTML = `
        <a href="admin.html" class="mm-nav-link" style="color:#facc15;font-weight:600;">
          üîß Admin Panel
        </a>`;
    } else {
      adminContainer.innerHTML = "";
    }
  }

  // --- Auth Init ---
  async function initAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session?.user ?? null;
    updateAuthUI();
    await checkAdmin();

    supabase.auth.onAuthStateChange(async (_evt, session) => {
      currentUser = session?.user ?? null;
      updateAuthUI();
      await checkAdmin();
    });
  }

  // --- Auth Buttons ---
  loginGoogleButton?.addEventListener("click", async () => {
    await supabase.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo: window.location.href },
    });
  });

  loginEmailButton?.addEventListener("click", async () => {
    const email = prompt("Enter your email:");
    if (!email) return;
    await supabase.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: window.location.href },
    });
    alert("Magic link sent!");
  });

  logoutButton?.addEventListener("click", async () => {
    await supabase.auth.signOut();
  });

  await initAuth();
</script>
