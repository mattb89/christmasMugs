<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mug Mapper ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- W3CSS + global styles -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      background: #020617;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding-top: 58px;   /* sticky header */
      padding-bottom: 48px;/* sticky footer */
    }

    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 16px 80px;
    }

    .admin-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .admin-subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .tab-btn {
      font-size: 0.85rem;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
    }

    .tab-btn.active {
      background: rgba(234, 179, 8, 0.15);
      border-color: #eab308;
      color: #facc15;
      font-weight: 600;
    }

    .admin-card {
      background: #0b1220;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.25);
      padding: 14px 14px 16px;
      margin-bottom: 16px;
    }

    .admin-status {
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .admin-status.err {
      color: #fecaca;
    }

    .admin-status.ok {
      color: #a7f3d0;
    }

    /* Photos tab */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }

    .photo-card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(55,65,81,0.9);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .photo-card img {
      width: 100%;
      height: 230px;
      object-fit: cover;
      display: block;
    }

    .photo-body {
      padding: 8px 10px 10px;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .photo-meta-main {
      font-weight: 500;
    }

    .photo-meta-sub {
      color: #9ca3af;
    }

    .photo-meta-tag {
      display: inline-block;
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      margin-right: 4px;
      margin-top: 2px;
    }

    .photo-actions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .btn-approve,
    .btn-reject,
    .btn-secondary {
      flex: 1;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.78rem;
      padding: 4px 8px;
      cursor: pointer;
      color: #e5e7eb;
    }

    .btn-approve {
      background: #16a34a;
    }
    .btn-approve:hover {
      background: #22c55e;
    }

    .btn-reject {
      background: #b91c1c;
    }
    .btn-reject:hover {
      background: #dc2626;
    }

    .btn-secondary {
      background: #0369a1;
    }
    .btn-secondary:hover {
      background: #0284c7;
    }

    /* Markets tab */
    .markets-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 12px;
    }

    @media (max-width: 900px) {
      .markets-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .market-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .market-item {
      border-radius: 10px;
      background: #020617;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 8px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .market-item.selected {
      border-color: #eab308;
      box-shadow: 0 0 0 1px rgba(234,179,8,0.4);
    }

    .market-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .market-meta {
      color: #9ca3af;
      font-size: 0.78rem;
    }

    .market-email {
      font-size: 0.75rem;
      color: #a5b4fc;
      margin-top: 2px;
    }

    .market-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .market-location-text {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    #adminMarketMap {
      width: 100%;
      height: 320px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(55,65,81,0.9);
    }

    .map-instructions {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 6px;
    }

    .mm-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 48px;
      background: #020617;
      border-top: 1px solid rgba(30,64,175,0.7);
      color: #cbd5e1;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9980;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>

  <!-- Sticky header -->
  <div id="mm-header"></div>

  <div class="admin-container">
    <h2 class="admin-title">Admin Panel</h2>
    <div class="admin-subtitle">
      Approve mug photos and suggested markets. Only you (and other admins) can see this.
    </div>

    <div id="adminError" class="admin-status err" style="display:none;"></div>

    <div id="adminContent" style="display:none;">
      <!-- Tabs -->
      <div class="tab-buttons">
        <button id="tabPhotosBtn" class="tab-btn active">üì∏ Photos</button>
        <button id="tabMarketsBtn" class="tab-btn">üó∫Ô∏è Markets</button>
      </div>

      <!-- Photos Tab -->
      <section id="tabPhotos" class="admin-card">
        <div class="admin-status" id="photosStatus"></div>
        <div id="photosGrid" class="photo-grid"></div>
      </section>

      <!-- Markets Tab -->
      <section id="tabMarkets" class="admin-card" style="display:none;">
        <div class="admin-status" id="marketsStatus"></div>

        <div class="markets-layout">
          <!-- Pending markets list -->
          <div>
            <h3 style="font-size:0.9rem;margin-bottom:6px;">Pending Markets</h3>
            <div id="marketsList" class="market-list"></div>
          </div>

          <!-- Map & location info -->
          <div>
            <h3 style="font-size:0.9rem;margin-bottom:6px;">Set Market Location</h3>
            <div id="adminMarketMap"></div>
            <div class="map-instructions">
              1) Click a market on the left to select it.<br/>
              2) Either click on the map where the market is located <strong>or</strong> use the ‚ÄúCity Centroid‚Äù button.<br/>
              3) Then click <strong>Approve</strong> on that market.
            </div>
            <div id="selectedMarketCoords" class="market-location-text">
              No market selected.
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Sticky footer -->
  <footer class="mm-footer">
    <div class="mm-footer-inner">¬© 2025 Mug Mapper</div>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // -------------------------------------------------------
    // 1. Load shared header
    // -------------------------------------------------------
    const headerHTML = await fetch("header.html").then((r) => r.text());
    document.getElementById("mm-header").innerHTML = headerHTML;

    const mmHamburger   = document.getElementById("mmHamburger");
    const mmNavOverlay  = document.getElementById("mmNavOverlay");
    const mmNavClose    = document.getElementById("mmNavClose");
    const navLinks      = mmNavOverlay?.querySelectorAll(".mm-nav-link") || [];

    function openNav() {
      if (!mmNavOverlay) return;
      mmNavOverlay.style.display = "block";
      mmNavOverlay.setAttribute("aria-hidden", "false");
    }
    function closeNav() {
      if (!mmNavOverlay) return;
      mmNavOverlay.style.display = "none";
      mmNavOverlay.setAttribute("aria-hidden", "true");
    }
    mmHamburger?.addEventListener("click", openNav);
    mmNavClose?.addEventListener("click", closeNav);
    navLinks.forEach((link) => link.addEventListener("click", closeNav));


    // -------------------------------------------------------
    // 2. Supabase init + auth + admin check (null-safe)
    // -------------------------------------------------------
    const SUPABASE_URL = "https://tosyomhrxttlejwlqvsf.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvc3lvbWhyeHR0bGVqd2xxdnNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTQzMDIsImV4cCI6MjA3OTA3MDMwMn0.YukJ7MFLra2aDgvNXRYFSTEsxdGFMWy0I-pOm9CtQ_8";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authUserLabel      = document.getElementById("authUserLabel") || null;
    const authAvatar         = document.getElementById("authAvatar") || null;
    const adminContainer     = document.getElementById("adminLinkContainer") || null;
    const dashboardContainer = document.getElementById("dashboardLinkContainer") || null;
    const loginGoogleButton  = document.getElementById("loginGoogleButton") || null;
    const loginEmailButton   = document.getElementById("loginEmailButton") || null;
    const logoutButton       = document.getElementById("logoutButton") || null;

    let currentUser      = null;
    let isAdmin          = false;
    let adminInitialized = false;

    function renderAdminLink() {
      if (!adminContainer) return;
      adminContainer.innerHTML = isAdmin
        ? `<a href="admin.html" class="mm-nav-link" style="color:#facc15;font-weight:600;">üîß Admin Panel</a>`
        : "";
    }

    function renderDashboardLink() {
      if (!dashboardContainer) return;
      dashboardContainer.innerHTML = currentUser
        ? `<a href="dashboard.html" class="mm-nav-link" style="color:#a5f3fc;font-weight:600;">üë§ Dashboard</a>`
        : "";
    }

    function updateAuthUI() {
      if (!authUserLabel) return;

      if (currentUser) {
        const meta = currentUser.user_metadata || {};
        const displayName = currentUser.email || meta.full_name || meta.name || currentUser.id;

        const adminBadgeHTML = isAdmin
          ? `<span style="
              background:#f97316;
              color:#111827;
              font-size:0.7rem;
              padding:2px 7px;
              border-radius:999px;
              font-weight:600;
              letter-spacing:0.05em;
            ">Admin</span>`
          : "";

        authUserLabel.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
            <span>${displayName}</span>
            ${adminBadgeHTML}
          </div>
        `;

        const avatarUrl = meta.avatar_url || meta.picture || null;
        if (authAvatar) {
          authAvatar.style.display = avatarUrl ? "block" : "none";
          if (avatarUrl) authAvatar.src = avatarUrl;
        }

        if (loginGoogleButton) loginGoogleButton.style.display = "none";
        if (loginEmailButton)  loginEmailButton.style.display  = "none";
        if (logoutButton)      logoutButton.style.display      = "block";
      } else {
        authUserLabel.textContent = "Not signed in";

        if (authAvatar) authAvatar.style.display = "none";
        if (loginGoogleButton) loginGoogleButton.style.display = "block";
        if (loginEmailButton)  loginEmailButton.style.display  = "block";
        if (logoutButton)      logoutButton.style.display      = "none";
      }

      renderDashboardLink();
    }

    async function checkAdmin() {
      const adminError   = document.getElementById("adminError");
      const adminContent = document.getElementById("adminContent");

      if (!currentUser) {
        isAdmin = false;
        renderAdminLink();
        updateAuthUI();

        adminError.style.display   = "block";
        adminError.textContent     = "Admin access required. Please sign in.";
        adminContent.style.display = "none";
        return;
      }

      const { data, error } = await supabase
        .from("admin_users")
        .select("user_id")
        .eq("user_id", currentUser.id)
        .maybeSingle();

      if (error) {
        console.error("Error checking admin_users:", error);
      }

      isAdmin = !!data;
      renderAdminLink();
      updateAuthUI();

      if (!isAdmin) {
        adminError.style.display   = "block";
        adminError.textContent     = "Admin access required.";
        adminContent.style.display = "none";
      } else {
        adminError.style.display   = "none";
        adminContent.style.display = "block";
        if (!adminInitialized) {
          adminInitialized = true;
          initAdminUI();
        }
      }
    }

    async function initAuth() {
      const {
        data: { session },
      } = await supabase.auth.getSession();

      currentUser = session?.user ?? null;
      await checkAdmin();

      supabase.auth.onAuthStateChange(async (_event, session) => {
        currentUser = session?.user ?? null;
        await checkAdmin();
      });
    }

    if (loginGoogleButton) {
      loginGoogleButton.addEventListener("click", async () => {
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: { redirectTo: window.location.href },
        });
        if (error) alert("Google sign-in error: " + error.message);
      });
    }

    if (loginEmailButton) {
      loginEmailButton.addEventListener("click", async () => {
        const email = prompt("Enter your email for a sign-in link:");
        if (!email) return;
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: window.location.href },
        });
        if (error) alert("Email sign-in error: " + error.message);
        else alert("Magic link sent. Check your inbox.");
      });
    }

    if (logoutButton) {
      logoutButton.addEventListener("click", async () => {
        await supabase.auth.signOut();
      });
    }


    // -------------------------------------------------------
    // 3. Admin UI: tabs, photos, markets, map
    // -------------------------------------------------------
    const tabPhotosBtn  = document.getElementById("tabPhotosBtn");
    const tabMarketsBtn = document.getElementById("tabMarketsBtn");
    const tabPhotos     = document.getElementById("tabPhotos");
    const tabMarkets    = document.getElementById("tabMarkets");

    const photosStatus  = document.getElementById("photosStatus");
    const photosGrid    = document.getElementById("photosGrid");
    const marketsStatus = document.getElementById("marketsStatus");
    const marketsList   = document.getElementById("marketsList");
    const coordsLabel   = document.getElementById("selectedMarketCoords");

    let pendingMarkets      = [];
    let selectedMarketId    = null;
    let coordsByMarket      = {};
    let adminMap            = null;
    let adminMapMarker      = null;
    let mapInitialized      = false;

    function setStatus(el, msg, isError = false) {
      if (!el) return;
      el.textContent = msg || "";
      el.className = "admin-status " + (isError ? "err" : "ok");
    }

    function showPhotosTab() {
      tabPhotos.style.display  = "block";
      tabMarkets.style.display = "none";
      tabPhotosBtn.classList.add("active");
      tabMarketsBtn.classList.remove("active");
    }

    function showMarketsTab() {
      tabPhotos.style.display  = "none";
      tabMarkets.style.display = "block";
      tabPhotosBtn.classList.remove("active");
      tabMarketsBtn.classList.add("active");

      if (!mapInitialized) {
        initAdminMap();
        mapInitialized = true;
      }
      if (adminMap) {
        setTimeout(() => adminMap.invalidateSize(), 100);
      }
    }

    tabPhotosBtn.addEventListener("click", showPhotosTab);
    tabMarketsBtn.addEventListener("click", showMarketsTab);


    // ------------------ Photos ------------------
    async function loadPendingPhotos() {
      setStatus(photosStatus, "Loading pending photos‚Ä¶", false);
      photosGrid.innerHTML = "";

      const { data, error } = await supabase
        .from("mug_photos")
        .select(`
          id,
          public_url,
          year,
          caption,
          status,
          market_id,
          uploader_email,
          markets (
            market_name,
            city,
            country
          )
        `)
        .eq("status", "pending")
        .order("created_at", { ascending: true });

      if (error) {
        console.error("Error loading pending photos:", error);
        setStatus(photosStatus, "Error loading pending photos.", true);
        return;
      }

      if (!data || !data.length) {
        setStatus(photosStatus, "No pending photos. üéâ", false);
        photosGrid.innerHTML = "";
        return;
      }

      setStatus(photosStatus, "", false);

      data.forEach((p) => {
        const card = document.createElement("div");
        card.className = "photo-card";

        const img = document.createElement("img");
        img.src = p.public_url;
        img.alt = "Pending mug photo";

        const body = document.createElement("div");
        body.className = "photo-body";

        const main = document.createElement("div");
        main.className = "photo-meta-main";
        const mkt = p.markets;
        main.textContent = mkt
          ? `${mkt.market_name} ‚Äì ${mkt.city}, ${mkt.country}`
          : "Unknown market";

        const sub = document.createElement("div");
        sub.className = "photo-meta-sub";
        sub.textContent =
          (p.caption ? `"${p.caption}" ¬∑ ` : "") +
          (p.uploader_email ? p.uploader_email : "Unknown uploader");

        const tags = document.createElement("div");
        if (p.year) {
          const t = document.createElement("span");
          t.className = "photo-meta-tag";
          t.textContent = `Year ${p.year}`;
          tags.appendChild(t);
        }

        const actions = document.createElement("div");
        actions.className = "photo-actions";

        const approveBtn = document.createElement("button");
        approveBtn.className = "btn-approve";
        approveBtn.textContent = "Approve";
        approveBtn.addEventListener("click", () => handlePhotoApproval(p.id, true));

        const rejectBtn = document.createElement("button");
        rejectBtn.className = "btn-reject";
        rejectBtn.textContent = "Reject";
        rejectBtn.addEventListener("click", () => handlePhotoApproval(p.id, false));

        actions.appendChild(approveBtn);
        actions.appendChild(rejectBtn);

        body.appendChild(main);
        body.appendChild(sub);
        body.appendChild(tags);
        body.appendChild(actions);

        card.appendChild(img);
        card.appendChild(body);
        photosGrid.appendChild(card);
      });
    }

    async function handlePhotoApproval(photoId, approve) {
      const { error } = await supabase
        .from("mug_photos")
        .update({ status: approve ? "approved" : "rejected" })
        .eq("id", photoId);

      if (error) {
        console.error("Error updating mug_photos:", error);
        alert("Error updating photo. See console.");
        return;
      }

      await loadPendingPhotos();
    }


    // ------------------ Markets + Map ------------------
    function initAdminMap() {
      adminMap = L.map("adminMarketMap", {
        center: [51.1657, 10.4515], // Central Europe-ish
        zoom: 4,
      });

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(adminMap);

      adminMap.on("click", (e) => {
        if (!selectedMarketId) {
          alert("Select a market from the list first.");
          return;
        }

        const { lat, lng } = e.latlng;
        coordsByMarket[selectedMarketId] = { lat, lng };

        if (adminMapMarker) {
          adminMapMarker.remove();
        }
        adminMapMarker = L.marker([lat, lng]).addTo(adminMap);

        const m = pendingMarkets.find((m) => m.id === selectedMarketId);
        if (m) {
          updateCoordsLabel(m);
        }
      });
    }

    function updateCoordsLabel(market) {
      const coords = coordsByMarket[market.id] || {
        lat: market.lat,
        lng: market.lng,
      };

      if (!coords || coords.lat == null || coords.lng == null) {
        if (coordsLabel) {
          coordsLabel.textContent =
            `Selected market: ${market.market_name} (${market.city}, ${market.country}) ‚Äì ` +
            `no coordinates set yet. Click the map or use ‚ÄúCity Centroid‚Äù.`;
        }
      } else {
        if (coordsLabel) {
          coordsLabel.textContent =
            `Selected market: ${market.market_name} (${market.city}, ${market.country})` +
            ` ¬∑ lat: ${coords.lat.toFixed(5)}, lng: ${coords.lng.toFixed(5)}`;
        }
      }
    }

    async function loadPendingMarkets() {
      setStatus(marketsStatus, "Loading pending markets‚Ä¶", false);
      marketsList.innerHTML = "";
      pendingMarkets = [];
      selectedMarketId = null;
      if (coordsLabel) coordsLabel.textContent = "No market selected.";

      const { data, error } = await supabase
        .from("markets")
        .select("id, market_name, city, country, status, lat, lng, suggested_by_email")
        .eq("status", "pending")
        .order("created_at", { ascending: true });

      if (error) {
        console.error("Error loading pending markets:", error);
        setStatus(marketsStatus, "Error loading pending markets.", true);
        return;
      }

      if (!data || !data.length) {
        setStatus(marketsStatus, "No pending markets. üéâ", false);
        marketsList.innerHTML = "";
        return;
      }

      pendingMarkets = data;
      setStatus(marketsStatus, "", false);

      data.forEach((m) => {
        const item = document.createElement("div");
        item.className = "market-item";
        item.dataset.marketId = m.id;

        const name = document.createElement("div");
        name.className = "market-name";
        name.textContent = m.market_name;

        const meta = document.createElement("div");
        meta.className = "market-meta";
        meta.textContent = `${m.city}, ${m.country}`;

        const email = document.createElement("div");
        email.className = "market-email";
        email.textContent = m.suggested_by_email
          ? `Suggested by: ${m.suggested_by_email}`
          : "Suggested by: unknown";

        const locText = document.createElement("div");
        locText.className = "market-location-text";
        if (m.lat != null && m.lng != null) {
          locText.textContent =
            `Current coordinates: lat ${m.lat.toFixed(5)}, lng ${m.lng.toFixed(5)}`;
        } else {
          locText.textContent = "No coordinates set yet.";
        }

        const actions = document.createElement("div");
        actions.className = "market-actions";

        const centroidBtn = document.createElement("button");
        centroidBtn.className = "btn-secondary";
        centroidBtn.textContent = "Use City Centroid";
        centroidBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          geocodeMarketCentroid(m.id, locText);
        });

        const approveBtn = document.createElement("button");
        approveBtn.className = "btn-approve";
        approveBtn.textContent = "Approve";
        approveBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          handleMarketApproval(m.id, true);
        });

        const rejectBtn = document.createElement("button");
        rejectBtn.className = "btn-reject";
        rejectBtn.textContent = "Reject";
        rejectBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          handleMarketApproval(m.id, false);
        });

        actions.appendChild(centroidBtn);
        actions.appendChild(approveBtn);
        actions.appendChild(rejectBtn);

        item.appendChild(name);
        item.appendChild(meta);
        item.appendChild(email);
        item.appendChild(locText);
        item.appendChild(actions);

        item.addEventListener("click", () => {
          selectMarket(m.id, item, locText);
        });

        marketsList.appendChild(item);
      });
    }

    function selectMarket(marketId, itemEl, locTextEl) {
      selectedMarketId = marketId;
      if (coordsLabel) coordsLabel.textContent = "";

      document
        .querySelectorAll(".market-item")
        .forEach((el) => el.classList.remove("selected"));
      itemEl.classList.add("selected");

      const market = pendingMarkets.find((m) => m.id === marketId);
      if (!market) return;

      const coords = coordsByMarket[market.id] || {
        lat: market.lat,
        lng: market.lng,
      };

      if (coords && coords.lat != null && coords.lng != null && adminMap) {
        if (adminMapMarker) adminMapMarker.remove();
        adminMapMarker = L.marker([coords.lat, coords.lng]).addTo(adminMap);
        adminMap.setView([coords.lat, coords.lng], 10);

        locTextEl.textContent =
          `Current coordinates: lat ${coords.lat.toFixed(5)}, lng ${coords.lng.toFixed(5)}`;
      }

      updateCoordsLabel(market);
    }

    async function geocodeMarketCentroid(marketId, locTextEl) {
      const market = pendingMarkets.find((m) => m.id === marketId);
      if (!market) return;

      const q = encodeURIComponent(`${market.city}, ${market.country}`);
      locTextEl.textContent = "Looking up city centroid‚Ä¶";

      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`,
          {
            headers: {
              "Accept": "application/json"
            }
          }
        );

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        if (!data || !data.length) {
          locTextEl.textContent = "No centroid found for this city.";
          return;
        }

        const hit = data[0];
        const lat = parseFloat(hit.lat);
        const lng = parseFloat(hit.lon);

        coordsByMarket[marketId] = { lat, lng };

        if (adminMap) {
          if (adminMapMarker) adminMapMarker.remove();
          adminMapMarker = L.marker([lat, lng]).addTo(adminMap);
          adminMap.setView([lat, lng], 11);
        }

        locTextEl.textContent =
          `City centroid: lat ${lat.toFixed(5)}, lng ${lng.toFixed(5)} (from OpenStreetMap)`;

        if (marketId === selectedMarketId) {
          updateCoordsLabel(market);
        }
      } catch (err) {
        console.error("Error geocoding centroid:", err);
        locTextEl.textContent = "Error fetching centroid. Try clicking on the map instead.";
      }
    }

    async function handleMarketApproval(marketId, approve) {
      const market = pendingMarkets.find((m) => m.id === marketId);
      if (!market) return;

      if (!approve) {
        const { error } = await supabase
          .from("markets")
          .update({ status: "rejected" })
          .eq("id", marketId);

        if (error) {
          console.error("Error rejecting market:", error);
          alert("Error rejecting market. See console.");
          return;
        }
        await loadPendingMarkets();
        return;
      }

      const coords = coordsByMarket[marketId] || {
        lat: market.lat,
        lng: market.lng,
      };

      if (!coords || coords.lat == null || coords.lng == null) {
        alert(
          "This market doesn't have coordinates yet.\n\n" +
          "Please either:\n" +
          "‚Ä¢ Click the market location on the map, or\n" +
          "‚Ä¢ Use the 'Use City Centroid' button,\n\n" +
          "before approving."
        );
        return;
      }

      const updateData = {
        status: "approved",
        lat: coords.lat,
        lng: coords.lng,
      };

      const { error } = await supabase
        .from("markets")
        .update(updateData)
        .eq("id", marketId);

      if (error) {
        console.error("Error approving market:", error);
        alert("Error approving market. See console.");
        return;
      }

      await loadPendingMarkets();
    }


    // -------------------------------------------------------
    // 4. Initialize admin data (after admin check)
    // -------------------------------------------------------
    async function initAdminUI() {
      await loadPendingPhotos();
      await loadPendingMarkets();
      showPhotosTab();
    }

    // üîö Call initAuth only after everything is defined
    await initAuth();
  </script>
</body>
</html>
