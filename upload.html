<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mug Mapper – Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    body {
      margin: 0;
      background: #111827;
      color: #f9fafb;
      font-family: system-ui, -apple-system, sans-serif;

      /* space for sticky header & footer */
      padding-top: 58px;  /* header height */
      padding-bottom: 48px; /* footer height */
    }

    .mm-container {
      max-width: 850px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    .mm-card {
      background: #1f2937;
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 14px;
      padding: 18px 20px 26px;
    }

    h2 {
      margin-top: 0;
    }

    label {
      font-size: 0.9rem;
      margin-top: 12px;
      display: block;
    }

    select,
    input[type="number"],
    input[type="file"],
    textarea {
      width: 100%;
      padding: 10px 12px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #0f172a;
      color: #f9fafb;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .mm-submit-btn {
      background: #0ea5e9;
      color: #0f172a;
      font-weight: 600;
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      margin-top: 16px;
      width: 100%;
      letter-spacing: 0.08rem;
      cursor: pointer;
    }

    .mm-submit-btn:disabled {
      opacity: 0.6;
      cursor: progress;
    }

    .mm-link-btn {
      padding: 6px 12px;
      border-radius: 999px;
      background: transparent;
      border: 1px dashed #6b7280;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
      margin-top: 8px;
      display: inline-block;
    }

    .mm-msg {
      margin-top: 10px;
      font-size: 0.9rem;
      white-space: pre-line; /* so we can show multi-line errors */
    }

    /* Sticky footer */
    .mm-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 48px;
      background: #1f2937;
      color: #cbd5e1;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9980;
      font-size: 0.9rem;
      box-shadow: 0 -2px 4px rgba(15,23,42,0.4);
    }

    /* Modal */
    .mm-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 3000;
    }

    .mm-modal {
      width: 100%;
      max-width: 420px;
      background: #1f2937;
      border-radius: 12px;
      padding: 18px 20px 24px;
      border: 1px solid rgba(148,163,184,0.35);
    }

    .mm-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mm-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .mm-modal-close {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 1.3rem;
      cursor: pointer;
    }

    .mm-modal-close:hover {
      color: #fff;
    }

    @media (min-width: 640px) {
      .mm-card {
        padding: 22px 26px 28px;
      }
    }
  </style>
</head>

<body>

<!-- Sticky Header (injected) -->
<div id="mm-header"></div>

<div class="mm-container">
  <div class="mm-card">
    <h2>Upload Mug Photos</h2>
    <p>
      Upload up to <strong>3 mug photos</strong>. If a market isn’t listed, suggest a new one.
    </p>

    <div id="authHint" style="color:#94a3b8; margin-bottom:12px;">
      Please sign in to upload.
    </div>

    <div id="uploadMessage" class="mm-msg"></div>

    <form id="uploadForm" style="display:none;">
      <label for="countrySelect">Country</label>
      <select id="countrySelect"></select>

      <label for="citySelect">City</label>
      <select id="citySelect"></select>

      <label for="marketSelect">Market</label>
      <select id="marketSelect"></select>

      <button type="button" id="addMarketButton" class="mm-link-btn">
        + My Market Is Missing
      </button>

      <label for="yearInput">Year</label>
      <input type="number" id="yearInput" min="2000" max="2100" />

      <label for="fileInput">Photos (max 3)</label>
      <input type="file" id="fileInput" accept="image/*" multiple />

      <label for="captionInput">Caption (optional)</label>
      <textarea id="captionInput"></textarea>

      <label style="margin-top:10px;">
        <input type="checkbox" id="consentCheckbox" />
        I agree to display these photos publicly.
      </label>

      <button id="submitButton" type="submit" class="mm-submit-btn">
        Submit Photos
      </button>
    </form>
  </div>
</div>

 <!-- Sticky footer -->
  <footer class="mm-footer">
    <div class="mm-footer-inner">© 2025 Mug Mapper</div>
  </footer>

<!-- Add Market Modal -->
<div id="addMarketModal" class="mm-modal-backdrop">
  <div class="mm-modal">
    <div class="mm-modal-header">
      <div class="mm-modal-title">Add a New Market</div>
      <button id="closeModalButton" class="mm-modal-close">✕</button>
    </div>

    <p style="font-size:0.85rem;color:#9ca3af;">
      Add a missing market. It will appear as <strong>pending</strong> until approved.
    </p>

    <div id="modalMessage" class="mm-msg"></div>

    <form id="marketSuggestionForm" style="margin-top:12px;">
      <label for="suggestionCountry">Country</label>
      <input type="text" id="suggestionCountry" required />

      <label for="suggestionCity">City</label>
      <input type="text" id="suggestionCity" required />

      <label for="suggestionMarketName">Market Name</label>
      <input type="text" id="suggestionMarketName" required />

      <label for="suggestionDescription">Description (optional)</label>
      <textarea id="suggestionDescription"></textarea>

      <button type="submit" id="submitSuggestionButton" class="mm-submit-btn" style="margin-top:14px;">
        Save Market
      </button>
    </form>
  </div>
</div>

<script type="module">
    import { initHeader } from "./header.js";
    import { initAuth } from "./auth.js";
    import { supabase } from "./supabaseClient.js";

    // 1) Initialize header & auth
    await initHeader();
    await initAuth();

    const {
      data: { session },
    } = await supabase.auth.getSession();

    const currentUser = session?.user ?? null;

    const uploadForm = document.getElementById("uploadForm");
    const authHint   = document.getElementById("authHint");

    if (currentUser) {
      uploadForm.style.display = "block";
      authHint.style.display = "none";
    } else {
      uploadForm.style.display = "none";
      authHint.style.display = "block";
    }

  // import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // /* ---------------------------
  //    1. Load Sticky Header
  // --------------------------- */
  // const headerHTML = await fetch("header.html").then((r) => r.text());
  // document.getElementById("mm-header").innerHTML = headerHTML;

  // // Attach menu events after injection
  // const mmHamburger  = document.getElementById("mmHamburger");
  // const mmNavOverlay = document.getElementById("mmNavOverlay");
  // const mmNavClose   = document.getElementById("mmNavClose");
  // const navLinks     = mmNavOverlay.querySelectorAll(".mm-nav-link");

  // function openNav() {
  //   mmNavOverlay.style.display = "block";
  // }
  // function closeNav() {
  //   mmNavOverlay.style.display = "none";
  // }

  // mmHamburger?.addEventListener("click", openNav);
  // mmNavClose?.addEventListener("click", closeNav);
  // navLinks.forEach((a) => a.addEventListener("click", closeNav));

  // /* ---------------------------
  //    2. Supabase Init + Auth
  // --------------------------- */
  // const SUPABASE_URL = "https://tosyomhrxttlejwlqvsf.supabase.co";
  // const SUPABASE_ANON_KEY =
  //   "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvc3lvbWhyeHR0bGVqd2xxdnNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTQzMDIsImV4cCI6MjA3OTA3MDMwMn0.YukJ7MFLra2aDgvNXRYFSTEsxdGFMWy0I-pOm9CtQ_8";

  // const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // const authUserLabel     = document.getElementById("authUserLabel");
  // const loginGoogleButton = document.getElementById("loginGoogleButton");
  // const loginEmailButton  = document.getElementById("loginEmailButton");
  // const logoutButton      = document.getElementById("logoutButton");

  // const uploadForm  = document.getElementById("uploadForm");
  // const authHint    = document.getElementById("authHint");
  const uploadMsg   = document.getElementById("uploadMessage");

  // let currentUser = null;

  function setUploadMessage(type, text, extra) {
    if (!uploadMsg) return;
    uploadMsg.style.color = type === "error" ? "#fecaca" : "#bbf7d0";
    uploadMsg.textContent = text + (extra ? `\n${extra}` : "");
  }



  // async function initAuth() {
  //   const { data: { session } } = await supabase.auth.getSession();
  //   currentUser = session?.user ?? null;
  //   updateAuthUI();

  //   supabase.auth.onAuthStateChange((_event, session) => {
  //     currentUser = session?.user ?? null;
  //     updateAuthUI();
  //   });
  // }

  // loginGoogleButton?.addEventListener("click", async () => {
  //   await supabase.auth.signInWithOAuth({
  //     provider: "google",
  //     options: { redirectTo: window.location.href },
  //   });
  // });

  // loginEmailButton?.addEventListener("click", async () => {
  //   const email = prompt("Enter your email for a sign-in link:");
  //   if (!email) return;
  //   await supabase.auth.signInWithOtp({
  //     email,
  //     options: { emailRedirectTo: window.location.href },
  //   });
  // });

  // logoutButton?.addEventListener("click", async () => {
  //   await supabase.auth.signOut();
  // });

  // await initAuth();

  /* ---------------------------
     3. Market Dropdown Logic
  --------------------------- */
  const countrySelect = document.getElementById("countrySelect");
  const citySelect    = document.getElementById("citySelect");
  const marketSelect  = document.getElementById("marketSelect");
  const yearInput     = document.getElementById("yearInput");
  const fileInput     = document.getElementById("fileInput");
  const captionInput  = document.getElementById("captionInput");
  const consent       = document.getElementById("consentCheckbox");
  const submitButton  = document.getElementById("submitButton");

  let allMarkets = [];

  async function loadMarkets(user) {
    let query = supabase
      .from("markets")
      .select("id, country, city, market_name, status, created_by")
      .order("country")
      .order("city")
      .order("market_name");

    if (user) {
      query = query.or(`status.eq.approved,created_by.eq.${user.id}`);
    } else {
      query = query.eq("status", "approved");
    }

    const { data, error } = await query;
    if (error) {
      console.error("Error loading markets:", error);
      setUploadMessage("error", "Error loading markets.", error.message);
      return;
    }

    allMarkets = data || [];
    populateCountryDropdown();
  }

  function populateCountryDropdown() {
    const countries = [...new Set(allMarkets.map((m) => m.country))].sort();
    countrySelect.innerHTML = `<option value="">Select country</option>`;
    countries.forEach((c) => {
      const o = document.createElement("option");
      o.value = c;
      o.textContent = c;
      countrySelect.appendChild(o);
    });
    citySelect.innerHTML   = `<option value="">Select country first</option>`;
    marketSelect.innerHTML = `<option value="">Select city first</option>`;
  }

  countrySelect.addEventListener("change", () => {
    const country = countrySelect.value;
    if (!country) {
      citySelect.innerHTML   = `<option value="">Select country first</option>`;
      marketSelect.innerHTML = `<option value="">Select city first</option>`;
      return;
    }

    const cities = [
      ...new Set(allMarkets.filter((m) => m.country === country).map((m) => m.city)),
    ].sort();

    citySelect.innerHTML = `<option value="">Select city</option>`;
    cities.forEach((c) => {
      const o = document.createElement("option");
      o.value = c;
      o.textContent = c;
      citySelect.appendChild(o);
    });

    marketSelect.innerHTML = `<option value="">Select city first</option>`;
  });

  citySelect.addEventListener("change", () => {
    const country = countrySelect.value;
    const city    = citySelect.value;

    const markets = allMarkets.filter(
      (m) => m.country === country && m.city === city
    );

    marketSelect.innerHTML = `<option value="">Select market</option>`;
    markets.forEach((m) => {
      const o = document.createElement("option");
      o.value = m.id;
      o.textContent = m.status === "pending"
        ? `${m.market_name} (pending)`
        : m.market_name;
      marketSelect.appendChild(o);
    });
  });

  /* ---------------------------
     4. Add Market Modal
  --------------------------- */
  const addMarketButton      = document.getElementById("addMarketButton");
  const addMarketModal       = document.getElementById("addMarketModal");
  const closeModalButton     = document.getElementById("closeModalButton");
  const marketSuggestionForm = document.getElementById("marketSuggestionForm");
  const modalMessage         = document.getElementById("modalMessage");
  const suggestionCountry    = document.getElementById("suggestionCountry");
  const suggestionCity       = document.getElementById("suggestionCity");
  const suggestionMarketName = document.getElementById("suggestionMarketName");
  const suggestionDescription= document.getElementById("suggestionDescription");

  addMarketButton.addEventListener("click", () => {
    suggestionCountry.value    = countrySelect.value || "";
    suggestionCity.value       = citySelect.value || "";
    suggestionMarketName.value = "";
    suggestionDescription.value= "";
    modalMessage.textContent   = "";
    addMarketModal.style.display = "flex";
  });

  closeModalButton.addEventListener("click", () => {
    addMarketModal.style.display = "none";
  });

  marketSuggestionForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    modalMessage.textContent = "";

    if (!currentUser) {
      modalMessage.style.color = "#fecaca";
      modalMessage.textContent = "You must be signed in.";
      return;
    }

    const country = suggestionCountry.value.trim();
    const city    = suggestionCity.value.trim();
    const name    = suggestionMarketName.value.trim();
    const desc    = suggestionDescription.value.trim();

    if (!country || !city || !name) {
      modalMessage.style.color = "#fecaca";
      modalMessage.textContent = "Country, city, and market name are required.";
      return;
    }

    const { data, error } = await supabase
      .from("markets")
      .insert({
        country,
        city,
        market_name: name,
        description: desc || null,
        status: "pending",
        created_by: currentUser.id,
        created_by_email: currentUser.email,
      })
      .select()
      .single();

    if (error) {
      console.error("Error adding market:", error);
      modalMessage.style.color = "#fecaca";
      modalMessage.textContent = "Error adding market.\n" + error.message;
      return;
    }

    allMarkets.push(data);
    populateCountryDropdown();
    countrySelect.value = data.country;
    countrySelect.dispatchEvent(new Event("change"));
    citySelect.value = data.city;
    citySelect.dispatchEvent(new Event("change"));
    marketSelect.value = data.id;

    modalMessage.style.color = "#bbf7d0";
    modalMessage.textContent = "Market added as pending.";
    setTimeout(() => (addMarketModal.style.display = "none"), 800);
  });

  /* ---------------------------
     5. Upload Photos (with detailed errors)
  --------------------------- */
  function getExtension(filename) {
    return filename.split(".").pop().toLowerCase();
  }

  function generateStoragePath(marketId, year, file, i) {
    const ext = getExtension(file.name || "jpg");
    const id =
      (crypto.randomUUID && crypto.randomUUID()) ||
      `${Date.now()}_${i}`;
    return `${marketId}/${year}/${id}.${ext}`;
  }

  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    setUploadMessage("info", "Uploading...");
    console.log("Starting upload...");

    if (!currentUser) {
      setUploadMessage("error", "You must be signed in.");
      return;
    }

    const country  = countrySelect.value;
    const city     = citySelect.value;
    const marketId = marketSelect.value;
    const year     = parseInt(yearInput.value, 10);
    const files    = Array.from(fileInput.files || []);
    const caption  = captionInput.value.trim();

    if (!country || !city || !marketId) {
      setUploadMessage("error", "Please select a valid market.");
      return;
    }
    if (!year || isNaN(year)) {
      setUploadMessage("error", "Enter a valid year.");
      return;
    }
    if (!files.length) {
      setUploadMessage("error", "Attach at least one photo.");
      return;
    }
    if (files.length > 3) {
      setUploadMessage("error", "Max 3 photos allowed.");
      return;
    }
    if (!consent.checked) {
      setUploadMessage("error", "You must agree to public display.");
      return;
    }

    submitButton.disabled = true;

    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const path = generateStoragePath(marketId, year, file, i);

        console.log("Uploading to storage path:", path);

        const { data: uploadData, error: uploadError } = await supabase.storage
          .from("mugs")
          .upload(path, file, { upsert: false });

        if (uploadError) {
          console.error("Storage upload error:", uploadError);
          setUploadMessage(
            "error",
            "Upload failed during file upload.",
            uploadError.message || JSON.stringify(uploadError)
          );
          throw uploadError;
        }

        console.log("Storage upload OK:", uploadData);

        const { data: pub } = supabase.storage.from("mugs").getPublicUrl(path);
        const publicUrl = pub.publicUrl;

        console.log("Public URL:", publicUrl);

        const { error: insertError } = await supabase
          .from("mug_photos")
          .insert({
            market_id: Number(marketId), // assumes mug_photos.market_id is BIGINT
            uploader_id: currentUser.id,
            uploader_email: currentUser.email,
            storage_path: path,
            public_url: publicUrl,
            caption: caption || null,
            year,
            status: "pending",
            like_count: 0,
          });

        if (insertError) {
          console.error("DB insert error:", insertError);
          setUploadMessage(
            "error",
            "Upload failed while saving to the database.",
            insertError.message || JSON.stringify(insertError)
          );
          throw insertError;
        }

        console.log("DB insert OK for photo:", path);
      }

      setUploadMessage(
        "success",
        "Upload complete! Your photos are pending approval."
      );

      fileInput.value = "";
      captionInput.value = "";
      consent.checked = false;
    } catch (err) {
      console.error("Upload exception:", err);
      if (!uploadMsg.textContent || !uploadMsg.textContent.startsWith("Upload failed")) {
        setUploadMessage("error", "Upload failed. Please try again.", err.message || "");
      }
    } finally {
      submitButton.disabled = false;
    }
  });

  // ---------------------------
  // 6. Init page
  // ---------------------------
  await loadMarkets(currentUser);
  yearInput.value = new Date().getFullYear();
</script>

</body>
</html>
