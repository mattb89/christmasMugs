<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mug Mapper – Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="styles.css">

  <style>
    body { background:#111827; color:white; }
    .mm-container {
      max-width: 800px;
      margin: 100px auto;
      padding: 16px;
    }
    .mm-card {
      background:#020617;
      padding:20px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.3);
    }
    select, input, textarea {
      width:100%;
      padding:10px;
      border-radius:8px;
      margin-top:4px;
      background:#111827;
      color:white;
      border:1px solid #374151;
    }
    .mm-btn {
      background:#0ea5e9;
      color:#0f172a;
      padding:10px 20px;
      border-radius:999px;
      border:none;
      margin-top:12px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:0.1em;
    }
  </style>
</head>

<body>

<!-- Shared header -->
<div id="mm-header"></div>

<div class="mm-container">
  <div class="mm-card">
    <h2>Upload Mug Photos</h2>
    <p>Upload up to <b>3 mug photos</b>. If a market isn’t listed, suggest a new one.</p>

    <div id="authHint" style="color:#94a3b8; margin-bottom:12px;">Sign in to upload photos.</div>

    <div id="uploadMessage" style="margin:8px 0;"></div>

    <form id="uploadForm" style="display:none;">
      <label>Country</label>
      <select id="countrySelect"></select>

      <label>City</label>
      <select id="citySelect"></select>

      <label>Market</label>
      <select id="marketSelect"></select>
      <button type="button" id="addMarketButton" class="w3-button w3-border w3-small" style="margin-top:8px;">
        + My Market Is Missing
      </button>

      <label style="margin-top:12px;">Year</label>
      <input type="number" id="yearInput">

      <label style="margin-top:12px;">Photos (max 3)</label>
      <input type="file" id="fileInput" accept="image/*" multiple>

      <label style="margin-top:12px;">Caption (optional)</label>
      <textarea id="captionInput"></textarea>

      <label style="margin-top:12px;">
        <input type="checkbox" id="consentCheckbox"> I agree to display these photos publicly
      </label>

      <button type="submit" id="submitButton" class="mm-btn">Submit Photos</button>
    </form>
  </div>
</div>

<!-- Modals, Scripts (same logic as you saw before) -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  /* Load shared header */
  await fetch("header.html").then(r => r.text()).then(html => {
    document.getElementById("mm-header").innerHTML = html;
  });

  const supabase = createClient(
    "https://tosyomhrxttlejwlqvsf.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvc3lvbWhyeHR0bGVqd2xxdnNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTQzMDIsImV4cCI6MjA3OTA3MDMwMn0.YukJ7MFLra2aDgvNXRYFSTEsxdGFMWy0I-pOm9CtQ_8"
  );

  /* Auth references inside header */
  const authUserLabel = document.getElementById("authUserLabel");
  const loginGoogleButton = document.getElementById("loginGoogleButton");
  const loginEmailButton = document.getElementById("loginEmailButton");
  const logoutButton = document.getElementById("logoutButton");

  const uploadForm = document.getElementById("uploadForm");
  const authHint = document.getElementById("authHint");

  let currentUser = null;

  function syncAuthUI() {
    if (currentUser) {
      authUserLabel.textContent = currentUser.email;
      uploadForm.style.display = "block";
      authHint.style.display = "none";
      logoutButton.style.display = "block";
      loginGoogleButton.style.display = "none";
      loginEmailButton.style.display = "none";
    } else {
      authUserLabel.textContent = "Not signed in";
      uploadForm.style.display = "none";
      authHint.style.display = "block";
      logoutButton.style.display = "none";
      loginGoogleButton.style.display = "block";
      loginEmailButton.style.display = "block";
    }
  }

  async function initAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session?.user ?? null;
    syncAuthUI();

    supabase.auth.onAuthStateChange((_event, session) => {
      currentUser = session?.user ?? null;
      syncAuthUI();
    });
  }

  loginGoogleButton.onclick = async () => {
    await supabase.auth.signInWithOAuth({
      provider:"google",
      options:{ redirectTo:window.location.href }
    });
  };

  loginEmailButton.onclick = async () => {
    const email = prompt("Email for magic link:");
    if (!email) return;
    await supabase.auth.signInWithOtp({ email, options:{emailRedirectTo:window.location.href}});
  };

  logoutButton.onclick = async () => {
    await supabase.auth.signOut();
  };

  await initAuth();

  /* The market loading + upload handling logic stays identical to previous version */
  /* (I will re-generate that full block once you confirm theme + layout are good) */

</script>

</body>
</html>
