<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mug Mapper ‚Äì Most Popular Mugs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- W3CSS + global styles -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    body {
      margin: 0;
      background: #111827;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding-top: 58px;    /* sticky header space */
      padding-bottom: 48px; /* sticky footer space */
    }

    .popular-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 80px;
    }

    .popular-card {
      background: #1f2937;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.25);
      padding: 18px 18px 26px;
    }

    .popular-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .popular-title {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .popular-subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-top: 2px;
    }

    .popular-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .popular-filters label {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-right: 4px;
    }

    .popular-filters select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    .popular-info {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .popular-error {
      margin-top: 8px;
      color: #fecaca;
      font-size: 0.85rem;
      white-space: pre-line;
    }

    .gallery-grid {
      margin-top: 14px;
    }

    .gallery-item {
      background: #020617;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(55,65,81,0.7);
      display: flex;
      flex-direction: column;
    }

    .gallery-item img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .gallery-item-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px 9px;
      font-size: 0.8rem;
      color: #e5e7eb;
      gap: 6px;
    }

    .gallery-item-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .gallery-item-meta-main {
      font-weight: 500;
    }

    .gallery-item-meta-sub {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .like-button {
      cursor: pointer;
      font-size: 0.9rem;
      user-select: none;
      border: none;
      background: transparent;
      color: #fbbf24;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .like-button.disabled {
      opacity: 0.5;
      cursor: default;
    }

    .like-button span {
      font-size: 1rem;
    }

    .mm-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 48px;
      background: #1f2937;
      color: #cbd5e1;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9980;
      font-size: 0.9rem;
      box-shadow: 0 -2px 4px rgba(15,23,42,0.4);
    }

    /* Lightbox tweaks */
    @media (max-width: 640px) {
      .lightbox-inner {
        grid-template-columns: 1fr;
      }
      .lightbox-img-wrapper img {
        height: 50vh;
      }
    }
  </style>
</head>

<body>

<!-- Sticky Header -->
<div id="mm-header"></div>

<div class="popular-container">
  <div class="popular-card">
    <div class="popular-header">
      <div>
        <div class="popular-title">Most Popular Mugs</div>
        <div class="popular-subtitle">
          Sorted by likes. Filter by country and year.
        </div>
      </div>

      <div class="popular-filters">
        <div>
          <label for="countryFilter">Country</label>
          <select id="countryFilter">
            <option value="all">All countries</option>
          </select>
        </div>
        <div>
          <label for="yearFilter">Year</label>
          <select id="yearFilter">
            <option value="all">All years</option>
          </select>
        </div>
      </div>
    </div>

    <div id="popularInfo" class="popular-info">Loading popular mugs‚Ä¶</div>
    <div id="popularError" class="popular-error"></div>

    <div id="galleryGrid" class="gallery-grid"></div>
  </div>
</div>

<!-- Lightbox (uses same classes as styles.css / index) -->
<div id="lightbox" class="lightbox">
  <div class="lightbox-inner">
    <div class="lightbox-img-wrapper">
      <img id="lightboxImg" src="" alt="Mug photo" />
    </div>
    <div class="lightbox-meta">
      <div class="lightbox-title" id="lightboxTitle"></div>
      <div class="lightbox-subtitle" id="lightboxSubtitle"></div>
      <div class="lightbox-chips">
        <div class="chip" id="lightboxYear"></div>
        <div class="chip" id="lightboxLocation"></div>
      </div>
      <button id="lightboxLike" class="like-button">
        ‚ù§Ô∏è <span id="lightboxLikeCount">0</span>
      </button>
    </div>

    <div class="lightbox-controls">
      <button id="lightboxPrev" class="lightbox-btn lightbox-prev">&#10094;</button>
      <button id="lightboxNext" class="lightbox-btn lightbox-next">&#10095;</button>
      <button id="lightboxClose" class="lightbox-btn lightbox-close">&#10005;</button>
    </div>
  </div>
</div>

<!-- Sticky Footer -->
<footer class="mm-footer">
  <div class="mm-footer-inner">¬© 2025 Mug Mapper</div>
</footer>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ---------------------------
  // 1. Load shared header
  // ---------------------------
  const headerHTML = await fetch("header.html").then((r) => r.text());
  document.getElementById("mm-header").innerHTML = headerHTML;

  // Hamburger / overlay wiring
  const mmHamburger  = document.getElementById("mmHamburger");
  const mmNavOverlay = document.getElementById("mmNavOverlay");
  const mmNavClose   = document.getElementById("mmNavClose");
  const navLinks     = mmNavOverlay?.querySelectorAll(".mm-nav-link") || [];

  function openNav() {
    mmNavOverlay.style.display = "block";
    mmNavOverlay.setAttribute("aria-hidden", "false");
  }
  function closeNav() {
    mmNavOverlay.style.display = "none";
    mmNavOverlay.setAttribute("aria-hidden", "true");
  }

  mmHamburger?.addEventListener("click", openNav);
  mmNavClose?.addEventListener("click", closeNav);
  navLinks.forEach((link) => link.addEventListener("click", closeNav));

  // ---------------------------
  // 2. Supabase Init + Auth
  // ---------------------------
  const SUPABASE_URL = "https://tosyomhrxttlejwlqvsf.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvc3lvbWhyeHR0bGVqd2xxdnNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTQzMDIsImV4cCI6MjA3OTA3MDMwMn0.YukJ7MFLra2aDgvNXRYFSTEsxdGFMWy0I-pOm9CtQ_8";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const authUserLabel     = document.getElementById("authUserLabel");
  const loginGoogleButton = document.getElementById("loginGoogleButton");
  const loginEmailButton  = document.getElementById("loginEmailButton");
  const logoutButton      = document.getElementById("logoutButton");

  let currentUser    = null;
  let likedPhotoIds  = new Set();
  let currentPhotos  = [];
  let lightboxIndex  = 0;

  const countryFilter = document.getElementById("countryFilter");
  const yearFilter    = document.getElementById("yearFilter");
  const popularInfo   = document.getElementById("popularInfo");
  const popularError  = document.getElementById("popularError");
  const galleryGrid   = document.getElementById("galleryGrid");

  function updateAuthUI() {
    if (!authUserLabel) return;
    if (currentUser) {
      authUserLabel.textContent =
        currentUser.email || currentUser.user_metadata?.full_name || currentUser.id;
      loginGoogleButton.style.display = "none";
      loginEmailButton.style.display  = "none";
      logoutButton.style.display      = "block";
    } else {
      authUserLabel.textContent = "Not signed in";
      loginGoogleButton.style.display = "block";
      loginEmailButton.style.display  = "block";
      logoutButton.style.display      = "none";
    }
  }

  async function loadUserLikes() {
    if (!currentUser) {
      likedPhotoIds = new Set();
      return;
    }

    const { data, error } = await supabase
      .from("photo_likes")
      .select("photo_id")
      .eq("user_id", currentUser.id);

    if (error) {
      console.error("Error loading user likes:", error);
      likedPhotoIds = new Set();
      return;
    }

    likedPhotoIds = new Set((data || []).map((row) => row.photo_id));
  }

  async function initAuth() {
    const {
      data: { session },
    } = await supabase.auth.getSession();
    currentUser = session?.user ?? null;
    updateAuthUI();
    await loadUserLikes();

    supabase.auth.onAuthStateChange(async (_event, session) => {
      currentUser = session?.user ?? null;
      updateAuthUI();
      await loadUserLikes();
      renderGallery();
    });
  }

  loginGoogleButton?.addEventListener("click", async () => {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo: window.location.href },
    });
    if (error) alert("Google sign-in error: " + error.message);
  });

  loginEmailButton?.addEventListener("click", async () => {
    const email = prompt("Enter your email for a sign-in link:");
    if (!email) return;
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: window.location.href },
    });
    if (error) alert("Email sign-in error: " + error.message);
    else alert("Magic link sent. Check your inbox.");
  });

  logoutButton?.addEventListener("click", async () => {
    await supabase.auth.signOut();
  });

  await initAuth();

  // ---------------------------
  // 3. Load filter options (countries + years)
  // ---------------------------
  async function loadFilterOptions() {
    popularError.textContent = "";
    const { data, error } = await supabase
      .from("mug_photos")
      .select("year, markets(country)")
      .eq("status", "approved");

    if (error) {
      console.error("Error loading filter options:", error);
      popularError.textContent = "Error loading filters:\n" + error.message;
      return;
    }

    const rows = data || [];

    const countrySet = new Set();
    const yearSet    = new Set();

    rows.forEach((r) => {
      if (r.markets?.country) {
        countrySet.add(r.markets.country);
      }
      if (r.year) {
        yearSet.add(r.year);
      }
    });

    // Populate country filter
    countryFilter.innerHTML = `<option value="all">All countries</option>`;
    Array.from(countrySet)
      .sort((a, b) => a.localeCompare(b))
      .forEach((country) => {
        const opt = document.createElement("option");
        opt.value = country;
        opt.textContent = country;
        countryFilter.appendChild(opt);
      });

    // Populate year filter
    yearFilter.innerHTML = `<option value="all">All years</option>`;
    Array.from(yearSet)
      .sort((a, b) => b - a) // newest first
      .forEach((year) => {
        const opt = document.createElement("option");
        opt.value = year;
        opt.textContent = year;
        yearFilter.appendChild(opt);
      });
  }

  // ---------------------------
  // 4. Load popular photos (respect filters)
  // ---------------------------
  async function loadPopularPhotos() {
    popularError.textContent = "";
    popularInfo.textContent  = "Loading popular mugs‚Ä¶";
    galleryGrid.innerHTML    = "";

    let query = supabase
      .from("mug_photos")
      .select(`
        id,
        public_url,
        caption,
        year,
        like_count,
        status,
        market_id,
        created_at,
        markets (
          market_name,
          city,
          country
        )
      `)
      .eq("status", "approved");

    const countryValue = countryFilter.value;
    const yearValue    = yearFilter.value;

    if (countryValue && countryValue !== "all") {
      // filter on joined markets.country
      query = query.eq("markets.country", countryValue);
    }

    if (yearValue && yearValue !== "all") {
      query = query.eq("year", parseInt(yearValue, 10));
    }

    // Most popular first, then newest
    const { data, error } = await query
      .order("like_count", { ascending: false })
      .order("created_at", { ascending: false })
      .limit(200);

    if (error) {
      console.error("Error loading popular photos:", error);
      popularInfo.textContent = "";
      popularError.textContent = "Error loading popular mugs:\n" + error.message;
      return;
    }

    currentPhotos = data || [];

    if (!currentPhotos.length) {
      popularInfo.textContent = "No mugs found for this filter yet.";
      galleryGrid.innerHTML = `<div class="popular-info" style="margin-top:10px;">Try a different country or year.</div>`;
      return;
    }

    popularInfo.textContent = `${currentPhotos.length} mug(s) found.`;
    renderGallery();
  }

  countryFilter.addEventListener("change", loadPopularPhotos);
  yearFilter.addEventListener("change", loadPopularPhotos);

  // ---------------------------
  // 5. Render gallery
  // ---------------------------
  function renderGallery() {
    galleryGrid.innerHTML = "";
    if (!currentPhotos.length) return;

    currentPhotos.forEach((p, index) => {
      const item = document.createElement("div");
      item.className = "gallery-item";

      const img = document.createElement("img");
      img.src = p.public_url;
      img.alt = "Mug photo";
      img.loading = "lazy";
      img.style.cursor = "pointer";
      img.addEventListener("click", () => openLightbox(index));

      const info = document.createElement("div");
      info.className = "gallery-item-info";

      const meta = document.createElement("div");
      meta.className = "gallery-item-meta";

      const main = document.createElement("div");
      main.className = "gallery-item-meta-main";
      const mkt = p.markets;
      main.textContent = mkt
        ? mkt.market_name
        : "Unknown market";

      const sub = document.createElement("div");
      sub.className = "gallery-item-meta-sub";
      const locText = mkt
        ? `${mkt.city}, ${mkt.country}`
        : "Location unknown";
      sub.textContent = p.year
        ? `${locText} ¬∑ ${p.year}`
        : locText;

      meta.appendChild(main);
      meta.appendChild(sub);

      const likeBtn = document.createElement("button");
      likeBtn.className = "like-button";

      const isLiked = likedPhotoIds.has(p.id);
      likeBtn.innerHTML = isLiked
        ? `‚ù§Ô∏è <span>${p.like_count ?? 0}</span>`
        : `ü§ç <span>${p.like_count ?? 0}</span>`;

      likeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleLike(p.id, false);
      });

      if (!currentUser) {
        likeBtn.classList.add("disabled");
        likeBtn.title = "Sign in to like photos";
      }

      info.appendChild(meta);
      info.appendChild(likeBtn);

      item.appendChild(img);
      item.appendChild(info);
      galleryGrid.appendChild(item);
    });
  }

  // ---------------------------
  // 6. Lightbox
  // ---------------------------
  const lightbox            = document.getElementById("lightbox");
  const lightboxImg         = document.getElementById("lightboxImg");
  const lightboxTitleEl     = document.getElementById("lightboxTitle");
  const lightboxSubtitleEl  = document.getElementById("lightboxSubtitle");
  const lightboxYear        = document.getElementById("lightboxYear");
  const lightboxLocation    = document.getElementById("lightboxLocation");
  const lightboxLike        = document.getElementById("lightboxLike");
  const lightboxLikeCountEl = document.getElementById("lightboxLikeCount");
  const btnPrev             = document.getElementById("lightboxPrev");
  const btnNext             = document.getElementById("lightboxNext");
  const btnClose            = document.getElementById("lightboxClose");

  function openLightbox(index) {
    if (!currentPhotos.length) return;
    lightboxIndex = index;
    const p = currentPhotos[index];

    lightboxImg.src = p.public_url;
    lightboxTitleEl.textContent = p.markets?.market_name || "Mug Photo";
    lightboxSubtitleEl.textContent = p.caption || "";
    lightboxYear.textContent = p.year || "";

    const mkt = p.markets;
    lightboxLocation.textContent = mkt
      ? `${mkt.city}, ${mkt.country}`
      : "";

    const isLiked = likedPhotoIds.has(p.id);
    lightboxLikeCountEl.textContent = p.like_count ?? 0;
    lightboxLike.innerHTML = isLiked
      ? `‚ù§Ô∏è <span id="lightboxLikeCount">${p.like_count ?? 0}</span>`
      : `ü§ç <span id="lightboxLikeCount">${p.like_count ?? 0}</span>`;

    if (!currentUser) {
      lightboxLike.classList.add("disabled");
      lightboxLike.title = "Sign in to like photos";
    } else {
      lightboxLike.classList.remove("disabled");
      lightboxLike.title = "";
    }

    lightboxLike.onclick = () => handleLike(p.id, true);

    lightbox.classList.add("visible");
  }

  function closeLightbox() {
    lightbox.classList.remove("visible");
  }

  btnClose.addEventListener("click", closeLightbox);
  lightbox.addEventListener("click", (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  btnPrev.addEventListener("click", () => {
    if (!currentPhotos.length) return;
    lightboxIndex = (lightboxIndex - 1 + currentPhotos.length) % currentPhotos.length;
    openLightbox(lightboxIndex);
  });

  btnNext.addEventListener("click", () => {
    if (!currentPhotos.length) return;
    lightboxIndex = (lightboxIndex + 1) % currentPhotos.length;
    openLightbox(lightboxIndex);
  });

  // ---------------------------
  // 7. Like handler (toggle, uses photo_likes)
  // ---------------------------
  async function handleLike(photoId, fromLightbox) {
    if (!currentUser) {
      alert("Sign in to like photos.");
      return;
    }

    const alreadyLiked = likedPhotoIds.has(photoId);
    const photo = currentPhotos.find((p) => p.id === photoId);
    if (!photo) return;

    if (!alreadyLiked) {
      // Insert like
      const { error } = await supabase
        .from("photo_likes")
        .insert({ photo_id: photoId, user_id: currentUser.id });

      // 23505 = unique violation (already liked)
      if (error && error.code !== "23505") {
        console.error("Error inserting like:", error);
        return;
      }

      likedPhotoIds.add(photoId);
      photo.like_count = (photo.like_count ?? 0) + 1;
    } else {
      // Delete like
      const { error } = await supabase
        .from("photo_likes")
        .delete()
        .eq("photo_id", photoId)
        .eq("user_id", currentUser.id);

      if (error) {
        console.error("Error deleting like:", error);
        return;
      }

      likedPhotoIds.delete(photoId);
      photo.like_count = Math.max((photo.like_count ?? 0) - 1, 0);
    }

    // Re-render gallery
    renderGallery();

    // If lightbox is open, update that slide
    if (fromLightbox) {
      const idx = currentPhotos.findIndex((p) => p.id === photoId);
      if (idx !== -1) openLightbox(idx);
    }
  }

  // ---------------------------
  // 8. Init filters + data
  // ---------------------------
  await loadFilterOptions();
  await loadPopularPhotos();
</script>

</body>
</html>
