<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mug Map – Previous Years</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div class="page">
  <header>
    <div class="brand">
      <div class="logo-pill">☕</div>
      <div>
        <h1>EUROPEAN <span>MUG MAP</span></h1>
        <div class="tagline">Browse mugs from previous years.</div>
      </div>
    </div>
    <nav class="nav-links">
      <a href="index.html">Current Year</a>
      <a href="previous.html" class="active">Previous Years</a>
      <a href="popular.html">Popular Mugs</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="upload.html">Upload Mug</a>
    </nav>
  </header>

  <main>
    <div id="map"></div>

    <div class="footer-hint">
      <span class="key">☕</span>
      <span>Select a year, then click a mug marker.</span>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
      <div class="lightbox-controls">
        <button class="lightbox-btn lightbox-prev" type="button">&#10094;</button>
        <button class="lightbox-btn lightbox-next" type="button">&#10095;</button>
        <button class="lightbox-btn lightbox-close" type="button">
          <span>&times;</span>
        </button>
      </div>
      <div class="lightbox-inner">
        <div class="lightbox-img-wrapper">
          <img id="lightbox-image" src="" alt="Mug photo" />
        </div>
        <div class="lightbox-meta">
          <div class="lightbox-title" id="lightbox-title"></div>
          <div class="lightbox-subtitle" id="lightbox-subtitle"></div>
          <div class="lightbox-chips" id="lightbox-chips"></div>
          <p style="margin-top:0.5rem;">
            Use ← → or the arrow buttons to browse mugs from that year.
          </p>
        </div>
      </div>
    </div>

    <!-- Right panel -->
    <section id="galleryPanel" class="card" style="
      position:absolute;
      right:1.4rem;
      top:1.4rem;
      bottom:1.4rem;
      width:min(380px, 90vw);
      display:flex;
      flex-direction:column;
      gap:0.7rem;
      z-index:500;">
      <div>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
          <div>
            <div style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--accent);">
              Previous Years Gallery
            </div>
            <h2 id="panelTitle" style="font-size:1rem; margin-top:0.15rem;">
              Choose a year
            </h2>
            <div id="panelSubtitle" style="font-size:0.8rem; color:var(--text-muted);">
              Select a year, then click a city on the map.
            </div>
          </div>
          <div>
            <label for="yearSelect" style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted);">
              Year
            </label>
            <select id="yearSelect" style="margin-top:0.2rem; background:var(--bg-soft); color:var(--text-main); border-radius:999px; border:1px solid var(--border-subtle); padding:0.2rem 0.6rem; font-size:0.78rem;">
            </select>
          </div>
        </div>
      </div>
      <div id="panelGallery" class="gallery-grid"></div>
    </section>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data.js"></script>
<script src="gallery.js"></script>
<script>
  const map = L.map("map").setView([50.5, 11], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
  }).addTo(map);

  const mugIcon = L.divIcon({
    html: "☕",
    className: "mug-icon",
    iconSize: [40, 40],
    iconAnchor: [20, 20],
  });

  const panelTitle = document.getElementById("panelTitle");
  const panelSubtitle = document.getElementById("panelSubtitle");
  const panelGallery = document.getElementById("panelGallery");
  const yearSelect = document.getElementById("yearSelect");

  setupLightbox();

  const years = getAvailableYears().filter((y) => y !== CURRENT_YEAR);
  years.forEach((year) => {
    const opt = document.createElement("option");
    opt.value = year;
    opt.textContent = year;
    yearSelect.appendChild(opt);
  });

  if (years.length) {
    yearSelect.value = years[0];
  }

  function getSelectedYear() {
    return parseInt(yearSelect.value, 10);
  }

  function showMarketGallery(market, year) {
    const photos = market.photos.filter((p) => p.year === year);
    panelTitle.textContent = `${market.name}`;
    panelSubtitle.textContent = photos.length
      ? `${market.city} · ${year}`
      : `No mugs uploaded for ${year} at this market yet.`;

    if (!photos.length) {
      panelGallery.innerHTML = "";
      return;
    }

    renderGallery(panelGallery, photos, {
      city: market.city,
      marketName: market.name,
    });
  }

  markets.forEach((market) => {
    const marker = L.marker(market.coords, { icon: mugIcon }).addTo(map);
    marker.bindTooltip(market.city, { direction: "top", offset: [0, -10] });
    marker.on("click", () => {
      const year = getSelectedYear();
      showMarketGallery(market, year);
    });
  });

  yearSelect.addEventListener("change", () => {
    panelTitle.textContent = "Choose a city on the map";
    panelSubtitle.textContent = `Year: ${yearSelect.value}`;
    panelGallery.innerHTML = "";
  });
</script>
</body>
</html>
